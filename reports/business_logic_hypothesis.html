<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Harriet O’Brien, Vy Tran, Saniyah Khan, Rehinatu Usman">

<title>Business Logic Hypothesis (Qualitative and Quantitative Synthesis)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="business_logic_hypothesis_files/libs/clipboard/clipboard.min.js"></script>
<script src="business_logic_hypothesis_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="business_logic_hypothesis_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="business_logic_hypothesis_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="business_logic_hypothesis_files/libs/quarto-html/popper.min.js"></script>
<script src="business_logic_hypothesis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="business_logic_hypothesis_files/libs/quarto-html/anchor.min.js"></script>
<link href="business_logic_hypothesis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="business_logic_hypothesis_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="business_logic_hypothesis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="business_logic_hypothesis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="business_logic_hypothesis_files/libs/bootstrap/bootstrap-a74871fe4945b66d259aafc266475145.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#purpose" id="toc-purpose" class="nav-link active" data-scroll-target="#purpose"><span class="header-section-number">1</span> Purpose:</a></li>
  <li><a href="#insights-from-the-product-required-document-prd" id="toc-insights-from-the-product-required-document-prd" class="nav-link" data-scroll-target="#insights-from-the-product-required-document-prd"><span class="header-section-number">2</span> Insights from the Product Required Document (PRD)</a></li>
  <li><a href="#insights-from-the-interviews" id="toc-insights-from-the-interviews" class="nav-link" data-scroll-target="#insights-from-the-interviews"><span class="header-section-number">3</span> Insights from the Interviews</a>
  <ul class="collapse">
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">3.0.1</span> <strong>Interpretation</strong></a></li>
  </ul></li>
  <li><a href="#what-the-data-suggests-from-eda" id="toc-what-the-data-suggests-from-eda" class="nav-link" data-scroll-target="#what-the-data-suggests-from-eda"><span class="header-section-number">4</span> What the Data Suggests (from EDA)</a>
  <ul class="collapse">
  <li><a href="#interpretation-1" id="toc-interpretation-1" class="nav-link" data-scroll-target="#interpretation-1"><span class="header-section-number">4.0.1</span> <strong>Interpretation</strong></a></li>
  </ul></li>
  <li><a href="#combined-interpretation-proposed-business-rules" id="toc-combined-interpretation-proposed-business-rules" class="nav-link" data-scroll-target="#combined-interpretation-proposed-business-rules"><span class="header-section-number">5</span> Combined Interpretation: Proposed Business Rules</a>
  <ul class="collapse">
  <li><a href="#base-amount-tied-to-trip-duration" id="toc-base-amount-tied-to-trip-duration" class="nav-link" data-scroll-target="#base-amount-tied-to-trip-duration"><span class="header-section-number">5.0.1</span> <strong>Base Amount Tied to Trip Duration</strong></a></li>
  <li><a href="#mileage-component-with-tiered-or-reduced-rates" id="toc-mileage-component-with-tiered-or-reduced-rates" class="nav-link" data-scroll-target="#mileage-component-with-tiered-or-reduced-rates"><span class="header-section-number">5.0.2</span> <strong>Mileage Component with Tiered or Reduced Rates</strong></a></li>
  <li><a href="#receipts-component-with-a-middle-optimal-range" id="toc-receipts-component-with-a-middle-optimal-range" class="nav-link" data-scroll-target="#receipts-component-with-a-middle-optimal-range"><span class="header-section-number">5.0.3</span> <strong>Receipts Component with a Middle “Optimal” Range</strong></a></li>
  <li><a href="#efficiency-rule-based-on-miles-per-day" id="toc-efficiency-rule-based-on-miles-per-day" class="nav-link" data-scroll-target="#efficiency-rule-based-on-miles-per-day"><span class="header-section-number">5.0.4</span> <strong>“Efficiency” Rule Based on Miles per Day</strong></a></li>
  <li><a href="#minor-time-based-or-random-adjustments" id="toc-minor-time-based-or-random-adjustments" class="nav-link" data-scroll-target="#minor-time-based-or-random-adjustments"><span class="header-section-number">5.0.5</span> Minor Time-Based or Random Adjustments</a></li>
  <li><a href="#rounding-quirks-linked-to-specific-cents-values" id="toc-rounding-quirks-linked-to-specific-cents-values" class="nav-link" data-scroll-target="#rounding-quirks-linked-to-specific-cents-values"><span class="header-section-number">5.0.6</span> <strong>Rounding Quirks Linked to Specific Cents Values</strong></a></li>
  <li><a href="#combined-rule-structure-a-layered-system" id="toc-combined-rule-structure-a-layered-system" class="nav-link" data-scroll-target="#combined-rule-structure-a-layered-system"><span class="header-section-number">5.0.7</span> <strong>Combined Rule Structure: A Layered System</strong></a></li>
  </ul></li>
  <li><a href="#feature-engineering-strategy" id="toc-feature-engineering-strategy" class="nav-link" data-scroll-target="#feature-engineering-strategy"><span class="header-section-number">6</span> Feature Engineering Strategy</a>
  <ul class="collapse">
  <li><a href="#core-features-direct-inputs" id="toc-core-features-direct-inputs" class="nav-link" data-scroll-target="#core-features-direct-inputs"><span class="header-section-number">6.0.1</span> Core Features (Direct Inputs)</a></li>
  <li><a href="#ratio-based-features-capture-efficiency-patterns" id="toc-ratio-based-features-capture-efficiency-patterns" class="nav-link" data-scroll-target="#ratio-based-features-capture-efficiency-patterns"><span class="header-section-number">6.0.2</span> Ratio-Based Features (Capture Efficiency Patterns)</a></li>
  <li><a href="#scaled-features-standardized-for-modeling" id="toc-scaled-features-standardized-for-modeling" class="nav-link" data-scroll-target="#scaled-features-standardized-for-modeling"><span class="header-section-number">6.0.3</span> Scaled Features (Standardized for Modeling)</a></li>
  <li><a href="#features-supporting-nonlinear-patterns" id="toc-features-supporting-nonlinear-patterns" class="nav-link" data-scroll-target="#features-supporting-nonlinear-patterns"><span class="header-section-number">6.0.4</span> Features Supporting Nonlinear Patterns</a></li>
  <li><a href="#additional-features-that-could-be-tested-later-on" id="toc-additional-features-that-could-be-tested-later-on" class="nav-link" data-scroll-target="#additional-features-that-could-be-tested-later-on"><span class="header-section-number">6.0.5</span> Additional Features That Could Be Tested Later On</a></li>
  <li><a href="#alignment-with-current-modeling-work" id="toc-alignment-with-current-modeling-work" class="nav-link" data-scroll-target="#alignment-with-current-modeling-work"><span class="header-section-number">6.0.6</span> Alignment With Current Modeling Work</a></li>
  <li><a href="#overall-summary" id="toc-overall-summary" class="nav-link" data-scroll-target="#overall-summary"><span class="header-section-number">6.0.7</span> Overall Summary</a></li>
  </ul></li>
  <li><a href="#assumptions-limitations-and-risks" id="toc-assumptions-limitations-and-risks" class="nav-link" data-scroll-target="#assumptions-limitations-and-risks"><span class="header-section-number">7</span> Assumptions, Limitations, and Risks</a>
  <ul class="collapse">
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions"><span class="header-section-number">7.0.1</span> Assumptions</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations"><span class="header-section-number">7.0.2</span> Limitations</a></li>
  <li><a href="#risks" id="toc-risks" class="nav-link" data-scroll-target="#risks"><span class="header-section-number">7.0.3</span> Risks</a></li>
  <li><a href="#overall" id="toc-overall" class="nav-link" data-scroll-target="#overall"><span class="header-section-number">7.0.4</span> Overall</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Business Logic Hypothesis (Qualitative and Quantitative Synthesis)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Harriet O’Brien, Vy Tran, Saniyah Khan, Rehinatu Usman </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="purpose" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Purpose:</h1>
<p>The purpose of this Business Logic Hypothesis is to explain the possible rules and patterns behind ACME Corporation’s legacy reimbursement system. While the system’s internal code is unavailable, we can infer its behavior by combining three different sources of evidence: the Product Requirements Document (PRD), the employee interview transcripts, and the results of the Exploratory Data Analysis (EDA).</p>
<p>The <strong>PRD</strong> provides the high-level business context, including the system’s age, the absence of documentation, and the requirement to recreate its behavior as closely as possible, even if that behavior is unusual or outdated. The interviews offer qualitative insight into how long-time users perceive the system, highlighting recurring themes such as inconsistent reimbursements, possible thresholds, season variation, penalties for certain spending patterns and non-linear mileage calculations. These observations suggest that the system’s logic is complex, layered, and influenced by multiple interacting factors.</p>
<p>The <strong>EDA</strong> adds numerical evidence from these interviews by showing the actual statistical structure of the 1,000 historical cases. Correlation patterns, distribution shapes, and outlier behaviors help identify which variables appear to influence the reimbursement the most (e.g., receipts, trip duration, and mileage) and whether the relationships appear linear, non-linear, or threshold-based.</p>
<p>By integrating these three perspectives, this hypothesis proposes a set of plausible assumptions about how the system might be making its decisions. These ideas are not representing the system’s exact rules, but rather an interpretation of the patterns observed in both the data and employee experiences. The goal is to produce a structured, testable set of assumptions that can guide feature engineering and model development in the next stages of the project.</p>
</section>
<section id="insights-from-the-product-required-document-prd" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Insights from the Product Required Document (PRD)</h1>
<p>The PRD provides essential context about how legacy reimbursement engine operates. It describes the system as a 60-year-old black box with no source code or documentation, and partially broken, however, ACME still relies on it. This means that the inputs and outputs are observable but the internal calculation logic is unavaliable.</p>
<p>These are some of the analytical observations made:</p>
<ol type="1">
<li><strong>Long-Term Accumulation of Hidden Rules:</strong></li>
</ol>
<p>The PRD explains that the system has been modified repeatedly over many decades without proper documentation. In software engineering terms, this often produces systems that contain <em>implicit rules, outdated conditions, and one-off adjustments</em> that continue to affect outcomes. These rules remain active even if no one fully understands their purpose.</p>
<ol start="2" type="1">
<li><strong>Legacy Behavior Influenced by Past Policies:</strong></li>
</ol>
<p>As the original code cannot be accessed, it is likely that older business policies, temporary fixes, and historical adjustments still affect the calculations. Analytically, the output function may behave as a <strong>stack of older and newer rules,</strong> some which overlap or conflict.</p>
<ol start="3" type="1">
<li><strong>Evidence of Irregular Patterns:</strong></li>
</ol>
<p>The inconsistent reimbursements or sudden changes for specific trip lengths, suggests that the system uses <strong>conditional logic, thresholds. or nonlinear decision rules.</strong> These are the typical traits of older enterprise systems that were expanded over time without redesign.</p>
<ol start="4" type="1">
<li><strong>Reproduce Behavior Exactly:</strong></li>
</ol>
<p>The PRD stresses that the goal is not to “improve” the logic but to replicate the behavior exactly, even is some outputs are the results of outdated or flawed rules, In machine-learning terms, this requires approximating a function that may include noise, discontinuities, and non-intuitive interactions among variables.</p>
<p>Overall, the PRD highlights the legacy engine as a multi-factor decision system shaped by layers of past modifications. For our analysis, this means we must treat the reimbursement patterns as the product of complex interactions, not simple linear rules, and we must identify these patterns through data and interviews rather than documentation.</p>
</section>
<section id="insights-from-the-interviews" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Insights from the Interviews</h1>
<p>The interview transcripts provide qualitative evidence about how employees experience the legacy reimbursement system. Although the participants do not know the exact calculation rules, their observations point to consistent patterns in the system’s behavior. In software-engineering terms, many of these comments suggest the presence of conditional branches, hidden thresholds, nonlinear adjustments, and rule interactions that have accumulated over decades of system modifications.</p>
<p>Several themes appear repeatedly across the interviews:</p>
<ol type="1">
<li><strong>Mileage Does Not Increase Linearly</strong></li>
</ol>
<p>Employees describe the mileage portion as “tiered”, “curved”, or “dropping off” after the first segment of miles. - Lisa noted that the first ~100 miles are reimbursed at a high rate. but the rate decreases afterward in an irregular way. - Marcus and Dave both described cases where a longer trip earned <em>less</em> per mile than a shorter one.</p>
<p>These comments indicate that the system likely uses <strong>piecewise mileage rules</strong>, a <strong>curved function</strong>, or a <strong>tiered schedule</strong> rather than a simple “rate x miles” formula.</p>
<ol start="2" type="1">
<li><strong>Reciepts Prefer a Medium-Range Total</strong></li>
</ol>
<p>Many employees described better reimbursements for <strong>medium-range receipt totals</strong> and worse reimbursements at both the low and high ends.</p>
<ul>
<li>Smaller total receipts sometimes perform worse than submitting none.</li>
<li>Higher total receipts over ~800-100 appear to have diminishing returns.</li>
</ul>
<p>This suggests the presence of a <strong>preferred receipts range</strong>, with <strong>penalties</strong> for low amounts and <strong>reduced marginal benefit</strong> for high amounts.</p>
<ol start="3" type="1">
<li><strong>Trip Duration May Trigger Specific Bonuses</strong></li>
</ol>
<p>Multiple interviews mentioned a consistent bonus for <strong>5-day trips</strong>, while 4-6 day trips behaved normally.</p>
<ul>
<li>Lisa described this as predictable pattern.</li>
<li>Jennifer mentioned increased fairness complaints around slightly longer trips (7+ days).</li>
</ul>
<p>This implies that the system may include <strong>special-case duration bonuses</strong> or <strong>discrete thresholds</strong> based on trip length.</p>
<ol start="4" type="1">
<li><strong>Efficiency (Miles per Day) Appears to Influence Reimbursement</strong></li>
</ol>
<p>Kevin reported that the best reimbursements occur arounf <strong>180-220 miles per day</strong>, with drops on either side.</p>
<ul>
<li>Too little mileage per day appears “penalized”.</li>
<li>Too much mileage per day also reduces reimbursement.</li>
</ul>
<p>This patterns suggessts the system may evaluate <strong>mileage relative to duration</strong>, rewarding “efficient” travel through a <strong>ratio-based rule</strong>.</p>
<ol start="5" type="1">
<li><strong>Timing and Submission Patterns May Introduce Variation</strong></li>
</ol>
<p>Participants mentioned possible effects tied to: - end of quarter, - day of the week, - or more patterns showing specific months or seasons.</p>
<p>Although thse patterns may not appear directly in the dataset, they imply the presence of <strong>data-based modifiers</strong> or <strong>small random adjustments</strong>.</p>
<ol start="6" type="1">
<li><strong>Rounding Behavior Indicates a Quirk or Bug</strong></li>
</ol>
<p>Employees mentioned that receipts ending in <strong>.49</strong> or <strong>.99</strong> sometimes round “twice” or produce slightly inflated reimbursements.</p>
<p>This is consistent with the behavior of older financial systems, where certain cent values trigger unusual rounding paths.</p>
<hr>
<section id="interpretation" class="level3" data-number="3.0.1">
<h3 data-number="3.0.1" class="anchored" data-anchor-id="interpretation"><span class="header-section-number">3.0.1</span> <strong>Interpretation</strong></h3>
<p>With all this information, the interviews suggest that the legacy reimbursement engine is not driven by one simple formula but instead by <strong>multiple overlapping rules</strong>, including:</p>
<ul>
<li>thresholds</li>
<li>bonuses</li>
<li>diminshing returns</li>
<li>nonlinear mileage adjustments</li>
<li>rounding anomalies</li>
</ul>
<p>These patterns align with how aging systems evolve when they are extended for decades without refactoring, producing behavior that feels inconsistent to users but follows hidden internal conditions.</p>
</section>
</section>
<section id="what-the-data-suggests-from-eda" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> What the Data Suggests (from EDA)</h1>
<p>The Exploratory Data Analysis provides the first quantitative view of the legacy system behaves. Even though we cannot access the original reimbursement formula, the patterns in the data allows us to identify the variables that appear to influence the final output most strongly.</p>
<ol type="1">
<li><strong>Strong Influence of Receipt Totals</strong></li>
</ol>
<p>The strongest relationship in the dataset is between <strong>total_receipts_amount</strong> and <strong>reimbursement_amount</strong>.</p>
<p>The correlation is high, and the pairplots show a clear upward trend. This suggests that receipts form a major part of the reimbursement calculation, either through:</p>
<ul>
<li>direct proportional rule,</li>
<li>a capped/adjusted relationship, or</li>
<li>a decreased-return structure (where higher receipts contribute less per dollar).</li>
</ul>
<p>This aligns with interview comments noting that mid-range receipts perform well, but very high or very low receipts behave unpredictably.</p>
<ol start="2" type="1">
<li><strong>Moderate Influence of Mileage and Trip Duration</strong></li>
</ol>
<p>Miles traveled and trip duration show <strong>moderate</strong> but consistent positive correlations with reimbursement. The relationships are not as stong as receipts, which suggests they contribute to the output but may follow rules such as:</p>
<ul>
<li>mileage tiers (a higher rate for early miles, lower for additional miles),</li>
<li>daily allowances,</li>
<li>or bonus/penalty adjustments depending on distance or duration ranges.</li>
</ul>
<p>These moderate effects also reflect the interview mentions of having a preference for middle/medium receipts for certain trip lenghts.</p>
<ol start="3" type="1">
<li><strong>Right-Skewed Distributions and Outliers</strong></li>
</ol>
<p>Across miles traveled, receipts, and reimbursements, the distributions are right-skewed. Most trips are:</p>
<ul>
<li>short (3-7 days)</li>
<li>moderately priced</li>
<li>with typical reimbursements amounts between 1,200 and 1,800.</li>
</ul>
<p>A small number of cases involve long trips or high totaled receipts. These cases behave consistently within the overall patterns, indicating that they are <strong>not data errors,</strong> but rather high-cost travel events that the system still processes under its internal rules.</p>
<ol start="4" type="1">
<li><strong>No Evidence of Strong Nonlinear Clusters, but Variance Increases at Higher Values</strong></li>
</ol>
<p>The pairplots show smooth increasing relationships rather than distinct clusters. However, the spread widens at higher values. This implies:</p>
<ul>
<li>diminishing returns for additional miles or receipts,</li>
<li>layered conditional rules that create non-uniform patterns at the upper end.</li>
</ul>
<p>This is consistnent with the legacy system incorporating rule layers or thresholds, common in old enterprise systems that evolved thorugh incremental modifications.</p>
<hr>
<section id="interpretation-1" class="level3" data-number="4.0.1">
<h3 data-number="4.0.1" class="anchored" data-anchor-id="interpretation-1"><span class="header-section-number">4.0.1</span> <strong>Interpretation</strong></h3>
<p>All together, the EDA suggests that the legacy system’s logic may combine:</p>
<ol type="1">
<li><p>A per-day base amount tied to trip duration</p></li>
<li><p>A mileage component that increases reimbursement but not at a constant rate.</p></li>
<li><p>A receipts component with strong initial influence but reduced impact at high totals.</p></li>
</ol>
<p>These patterns align well with the interview findings, which describe nonlinear mileage treatment, medium-range receipts performing best, and bonuses at specific trip lengths.</p>
</section>
</section>
<section id="combined-interpretation-proposed-business-rules" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Combined Interpretation: Proposed Business Rules</h1>
<p>Putting together the findings from the PRD, the interview insights, and the EDA results, we can begin to understand how the legacy reimbursement engine may be operating. Although the exact internal logic is unknown, several patterns consistently appear across all three sources of evidence. These patterns suggest that the system likely applies a set of layered, conditional rules rather than a single formula. Below is a combined interpretation of the rules that may be governing the system’s behavior.</p>
<section id="base-amount-tied-to-trip-duration" class="level3" data-number="5.0.1">
<h3 data-number="5.0.1" class="anchored" data-anchor-id="base-amount-tied-to-trip-duration"><span class="header-section-number">5.0.1</span> <strong>Base Amount Tied to Trip Duration</strong></h3>
<p>The EDA shows a moderate positive relationship between trip_duration_days and reimbursement_amount. Interviews also repeatedly mention that certain trip lengths seem to trigger better reimbursements.</p>
<p><strong>Hypothesized Rule:</strong></p>
<ul>
<li><p>The system applies a daily base allowance (e.g., a fixed per-day amount).</p></li>
<li><p>A special case adjustment exists around <strong>5 Days</strong>, where reimbursements tend to be unusually high.</p></li>
<li><p>Trips slightly longer (e.g., 7+ days) may lose this benefit, which matches fairness concerns expressed by employees.</p></li>
</ul>
<p><strong>Why is this plausible:</strong></p>
<ul>
<li><p>Older systems often contain duration-based lookup tables or discrete bonuses.</p></li>
<li><p>Both EDA trends and interview descriptions support a duration rule with at least one threshold.</p></li>
</ul>
</section>
<section id="mileage-component-with-tiered-or-reduced-rates" class="level3" data-number="5.0.2">
<h3 data-number="5.0.2" class="anchored" data-anchor-id="mileage-component-with-tiered-or-reduced-rates"><span class="header-section-number">5.0.2</span> <strong>Mileage Component with Tiered or Reduced Rates</strong></h3>
<p>The correlation between miles_traveled and reimbursement is moderate, but the interviews consistently describe strange mileage behavior.</p>
<p><strong>Hypothesized Rule:</strong></p>
<ul>
<li><p>Early miles are reimbursed at a higher rate (e.g., first ~100 miles).</p></li>
<li><p>After a threshold, miles contribute less than expected.</p></li>
<li><p>The marginal rate may decrease in steps or follow a curve (e.g., a concave-down pattern).</p></li>
</ul>
<p><strong>Why this is plausible:</strong></p>
<ul>
<li><p>The EDA shows increasing reimbursement with mileage but with widening variance at higher ranges.</p></li>
<li><p>Users repeatedly describe situations where longer trips yield <strong><em>lower</em></strong> per mile payments than shorter ones.</p></li>
</ul>
<p>This suggests a <strong>nonlinear or tiered</strong> mileage structure.</p>
</section>
<section id="receipts-component-with-a-middle-optimal-range" class="level3" data-number="5.0.3">
<h3 data-number="5.0.3" class="anchored" data-anchor-id="receipts-component-with-a-middle-optimal-range"><span class="header-section-number">5.0.3</span> <strong>Receipts Component with a Middle “Optimal” Range</strong></h3>
<p>Receipts show the strongest correlation in the EDA, but interviews describe non-linear behavior:</p>
<ul>
<li><p>Lower receipts sometimes worsen reimbursement.</p></li>
<li><p>Medium receipts (e.g., ~$600 - $800) produce strong outcomes.</p></li>
<li><p>Very high receipts show diminished benefit.</p></li>
</ul>
<p><strong>Hypothesized Rule:</strong></p>
<ul>
<li><p>The system rewards receipts that fall within a specific “acceptable” range.</p></li>
<li><p>Receipts below a low threshold may trigger a penalty.</p></li>
<li><p>Receipts above a high threshold may contribute less to the total (a diminishing return or soft cap).</p></li>
</ul>
<p><strong>Why this is plausible:</strong></p>
<ul>
<li><p>EDA confirms a strong but non-linear receipts-to-reimbursement trend.</p></li>
<li><p>Multiple employees describe rising receipts not always producing rising reimbursement.</p></li>
</ul>
</section>
<section id="efficiency-rule-based-on-miles-per-day" class="level3" data-number="5.0.4">
<h3 data-number="5.0.4" class="anchored" data-anchor-id="efficiency-rule-based-on-miles-per-day"><span class="header-section-number">5.0.4</span> <strong>“Efficiency” Rule Based on Miles per Day</strong></h3>
<p>Interview data (especially from Kevin) repeatedly highlights the effect of <strong><em>miles traveled per day</em></strong>. The EDA does not directly compute this ratio, but the underlying relationships support the idea.</p>
<p><strong>Hypothesized Rule:</strong></p>
<ul>
<li><p>The system evaluates mileage relative to trip duration.</p></li>
<li><p>An efficiency window (approximately 180-220 miles/day) yields the best reimbursements.</p></li>
<li><p>Too little mileage/day may signal “low productivity” to which it concludes to reduced reimbursement.</p></li>
<li><p>Too much mileage/day may signal unrealistic or “non-business” travel to which it conlcudes to reduced reimbursement.</p></li>
</ul>
<p><strong>Why this is plausible:</strong></p>
<ul>
<li><p>Efficiency metrics are common in older travel systems.</p></li>
<li><p>Interview reports show strong consistency about mileage/day patterns.</p></li>
</ul>
</section>
<section id="minor-time-based-or-random-adjustments" class="level3" data-number="5.0.5">
<h3 data-number="5.0.5" class="anchored" data-anchor-id="minor-time-based-or-random-adjustments"><span class="header-section-number">5.0.5</span> Minor Time-Based or Random Adjustments</h3>
<p>Although the dataset does not include timestamps, employees describe patterns relating to:</p>
<ul>
<li>days of the week,</li>
<li>end-of-quarter periods,</li>
<li>seasonal behavior,</li>
<li>and even perceived “randomness.”</li>
</ul>
<p><strong>Hypothesized Rule:</strong></p>
<ul>
<li><p>A small time based coefficient (e.g., monthly or quarterly adjustment) may modify totals.</p></li>
<li><p>Alternatively, the system includes a small random factor to avoid predictable gaming.</p></li>
</ul>
<p><strong>Why this is plausible:</strong></p>
<ul>
<li><p>Legacy Systems sometimes use date-based adjustments for budgeting cycles.</p></li>
<li><p>Older ramdom rounding or floating-point behavior can create irregular outputs.</p></li>
</ul>
<p>EDA cannot confirm these behaviors, but nothing contradicts them.</p>
</section>
<section id="rounding-quirks-linked-to-specific-cents-values" class="level3" data-number="5.0.6">
<h3 data-number="5.0.6" class="anchored" data-anchor-id="rounding-quirks-linked-to-specific-cents-values"><span class="header-section-number">5.0.6</span> <strong>Rounding Quirks Linked to Specific Cents Values</strong></h3>
<p>Several employees mention reimbursements behaving strangely when receipts end in <strong>.49</strong> or <strong>.99</strong>.</p>
<p><strong>Hypothesized Rule:</strong></p>
<ul>
<li><p>The system may use a rounding sequence that processes cents twice.</p></li>
<li><p>Certain ending values may trigger upward rounding or “favorable” rounding paths.</p></li>
</ul>
<p><strong>Why this is plausible:</strong></p>
<ul>
<li><p>Older COBOL-like systems frequently contain rounding logic that behaves inconsistently across cent patterns.</p></li>
<li><p>Interview accounts strong support this.</p></li>
</ul>
<p>The EDA does not include cent-level analysis, but the behavior is typical of legacy financial systems.</p>
</section>
<section id="combined-rule-structure-a-layered-system" class="level3" data-number="5.0.7">
<h3 data-number="5.0.7" class="anchored" data-anchor-id="combined-rule-structure-a-layered-system"><span class="header-section-number">5.0.7</span> <strong>Combined Rule Structure: A Layered System</strong></h3>
<p>Combining all the evidence, thus suggesting the legacy reimbursement engine most likely combines:</p>
<ol type="1">
<li>A base per-day amount</li>
<li>A tiered or curved mileage calculation</li>
<li>A receipts-based component with mid-range bonuses</li>
<li>A ratio-based efficiency multiplier (miles/day)</li>
<li>Small date-based or other small random variations</li>
<li>One or more unexpected behaviors with rounding</li>
</ol>
<p>This aligns with:</p>
<ul>
<li><p>PRD descriptions of a system modified repeatedly over decades</p></li>
<li><p>User interviews that highlight inconsistent but patterned behavior</p></li>
<li><p>EDA findings showing increasing but non-linear trends.</p></li>
</ul>
<p>The most likely explanation is that multiple conditional rules interact with each other, creating outputs that appear inconsistent but actually fixed-rule patterns within different ranges.</p>
</section>
</section>
<section id="feature-engineering-strategy" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Feature Engineering Strategy</h1>
<p>The purpose of feature engineering in this project is to translate the themes identified in the PRD, interviews, and EDA into measurable variables that the model can use to approximate the legacy system’s behavior. Because the original system likely uses layered rules, thresholds, and non-linear adjustments, the features must capture both simple relationships and more complex patterns.</p>
<p>The features created in the feature engineering notebook reflect this goal. Below is a structured explanation of the strategy behind them, why they are appropriate, and how they connect to the business logic hypothesis.</p>
<section id="core-features-direct-inputs" class="level3" data-number="6.0.1">
<h3 data-number="6.0.1" class="anchored" data-anchor-id="core-features-direct-inputs"><span class="header-section-number">6.0.1</span> Core Features (Direct Inputs)</h3>
<p>These are the variables directly provided in the dataset:</p>
<ul>
<li><strong>trip_duration_days</strong></li>
<li><strong>miles_traveled</strong></li>
<li><strong>total_receipts_amount</strong></li>
<li><strong>reimbursement_amount</strong> (target)</li>
</ul>
<p>Since the legacy system bases all decisions on these variables, they must be included without modification. They serve as the foundation for all additional engineered features.</p>
<p>The EDA shows that all three variables influence reimbursement (receipts strongest, mileage and duration moderately). Including them directly ensures the model retains the original information that drives payout decisions.</p>
</section>
<section id="ratio-based-features-capture-efficiency-patterns" class="level3" data-number="6.0.2">
<h3 data-number="6.0.2" class="anchored" data-anchor-id="ratio-based-features-capture-efficiency-patterns"><span class="header-section-number">6.0.2</span> Ratio-Based Features (Capture Efficiency Patterns)</h3>
<p>Several derived features were created to reflect patterns identified in the interviews and EDA:</p>
<ul>
<li><strong>miles_per_day</strong></li>
<li><strong>cost_per_day</strong></li>
<li><strong>cost_per_mile</strong></li>
<li><strong>receipts_ratio (receipts divided by reimbursement)</strong></li>
</ul>
<p>These ratio features help the model detect patterns described in interviews, such as:</p>
<ul>
<li>“efficient mileage” windows</li>
<li>diminishing returns</li>
<li>over-spending or under-spending effects</li>
</ul>
<p>Interviews repeatedly mention that reimbursement behave differently depending on balance (e.g., miles per day, spending relative to trip duration). These patterns cannot be detected from variables alone.</p>
</section>
<section id="scaled-features-standardized-for-modeling" class="level3" data-number="6.0.3">
<h3 data-number="6.0.3" class="anchored" data-anchor-id="scaled-features-standardized-for-modeling"><span class="header-section-number">6.0.3</span> Scaled Features (Standardized for Modeling)</h3>
<p>Since some models are sensitive to the scale of numerical variables, the following were standardized (z-scaling):</p>
<ul>
<li>trip_duration_days</li>
<li>miles_traveled</li>
<li>total_receipts_amount</li>
</ul>
<p>These scaling step does not modify the meaning of the features, it helps models handle the differences in magnitude, especially between miles(hundreds) and receipts (thousands).</p>
</section>
<section id="features-supporting-nonlinear-patterns" class="level3" data-number="6.0.4">
<h3 data-number="6.0.4" class="anchored" data-anchor-id="features-supporting-nonlinear-patterns"><span class="header-section-number">6.0.4</span> Features Supporting Nonlinear Patterns</h3>
<p>The interviews and EDA suggest several behaviors:</p>
<ul>
<li>mileage decreases in value after a certain point</li>
<li>receipts have a good middle range</li>
<li>long but expensive trips can be penalized</li>
</ul>
<p>The engineered features indirectly support these patterns:</p>
<ul>
<li><strong>cost_per_mile</strong> helps capture changes in mileage value</li>
<li><strong>cost_per_day</strong> helps detect duration based bonuses or penalties</li>
<li><strong>receipts_ratio</strong> helps capture diminishing returns on spending</li>
</ul>
<p>Even though explicit thresholds were not added, models like trees and regression can find thresholds and breakpoints automatically if the engineered features are done correctly.</p>
</section>
<section id="additional-features-that-could-be-tested-later-on" class="level3" data-number="6.0.5">
<h3 data-number="6.0.5" class="anchored" data-anchor-id="additional-features-that-could-be-tested-later-on"><span class="header-section-number">6.0.5</span> Additional Features That Could Be Tested Later On</h3>
<p>These features were identified as potentially useful based on interview claims but were not required for the initial modeling notebook. They are documented here to show that there are additional patterns that can be implemented:</p>
<ul>
<li><strong>is_five_day_trip</strong> (trip_duration_days == 5)</li>
<li><strong>receipt_low/receipt_mid/receipt_high</strong></li>
<li><strong>miles_per_day</strong> to indicate reimbursement value</li>
<li><strong>mileage_above_100</strong> (miles traveled &gt; 100)</li>
</ul>
<p>These options are avaliable if the model shows gaps in performance in specific ranges.</p>
</section>
<section id="alignment-with-current-modeling-work" class="level3" data-number="6.0.6">
<h3 data-number="6.0.6" class="anchored" data-anchor-id="alignment-with-current-modeling-work"><span class="header-section-number">6.0.6</span> Alignment With Current Modeling Work</h3>
<p>The feature engineering notebook already includes:</p>
<ul>
<li>miles_per_day</li>
<li>cost_per_mile</li>
<li>receipts_ratio</li>
<li>cost_per_day</li>
<li>scaled versions of numerical inputs</li>
</ul>
<p>These features directly match the patterns identified in the interviews and EDA, specifically:</p>
<ul>
<li>decreasing incremental value of additional receipts,</li>
<li>trip duration influencing reimbursements in a patterned way,</li>
<li>non-linear relationships between miles and reimbursement.</li>
</ul>
<p>Because these engineered features support the conditions suggested by the Business Logic Hypothesis, no additional changes are needed.</p>
</section>
<section id="overall-summary" class="level3" data-number="6.0.7">
<h3 data-number="6.0.7" class="anchored" data-anchor-id="overall-summary"><span class="header-section-number">6.0.7</span> Overall Summary</h3>
<p>Overall, the engineered features aim to:</p>
<ul>
<li><p>Represent meaningful travel behaviors (distance, spending, duration)</p></li>
<li><p>Capture efficiency and spending patterns through ratios</p></li>
<li><p>Support models in identifying nonlinear patterns seen in data</p></li>
<li><p>Align with employee descriptions of how the system behaves</p></li>
<li><p>Maintain compatability of the features engineering implemented and modeling pipeline</p></li>
</ul>
<p>This feature set provides a balanced starting point for both interpretability and predictable performance while remaining realistic with the limited inputs of the legacy system.</p>
</section>
</section>
<section id="assumptions-limitations-and-risks" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Assumptions, Limitations, and Risks</h1>
<p>The Business Logic Hypothesis is built from observable patterns in the data, qualitative insights from employee interviews, and context provided by the PRD. Because the original reimbursement engine is inaccessible, there are many assumptions and constraints in this analysis.</p>
<section id="assumptions" class="level3" data-number="7.0.1">
<h3 data-number="7.0.1" class="anchored" data-anchor-id="assumptions"><span class="header-section-number">7.0.1</span> Assumptions</h3>
<ol type="1">
<li><strong>Public cases reflect the same logic as the private set</strong></li>
</ol>
<p>We assume the historical cases provided in the dataset are consistent with the rules still used by the ACME’s legacy system.</p>
<ol start="2" type="1">
<li><strong>Interview descriptions accurately represent repeated system behaviors</strong></li>
</ol>
<p>The recurring statements across employees are treated as indications of underlying rules.</p>
<ol start="3" type="1">
<li><strong>The legacy system’s behavior is stable</strong></li>
</ol>
<p>We assume the reimbursement logic has not changed significantly in recent years despite system age and undocumented updates.</p>
</section>
<section id="limitations" class="level3" data-number="7.0.2">
<h3 data-number="7.0.2" class="anchored" data-anchor-id="limitations"><span class="header-section-number">7.0.2</span> Limitations</h3>
<ol type="1">
<li><strong>No access to internal logic or user-specific history</strong></li>
</ol>
<p>Features such as User ID, timestamps, or submission context is not present which limits our ability to test the claims about timing effects or user history.</p>
<ol start="2" type="1">
<li><strong>Some interview claims cannot be directly confirmed by the dataset</strong></li>
</ol>
<p>Examples include day of week differences, quarterly adjustments, or rounding anomalies based on specific cent values.</p>
<ol start="3" type="1">
<li><strong>Potential for multiple overlapping rules producing similar patterns</strong></li>
</ol>
<p>EDA findings may reflect combined effects of several conditions, making the exact rule reconstruction difficult.</p>
</section>
<section id="risks" class="level3" data-number="7.0.3">
<h3 data-number="7.0.3" class="anchored" data-anchor-id="risks"><span class="header-section-number">7.0.3</span> Risks</h3>
<ol type="1">
<li><strong>Overfitting to unexpected behaviors in the public dataset</strong></li>
</ol>
<p>If some patterns are a coincidence or dataset-specific, models may capture noise that doesn’t generalize to the private evaluation set.</p>
<ol start="2" type="1">
<li><strong>Misinterpreting nonlinear behavior as true rules</strong></li>
</ol>
<p>Without direct access to the system, there is a risk of attributing significance to patterns created by historical randomness or incomplete records.</p>
<ol start="3" type="1">
<li><strong>Missing hidden interactions</strong></li>
</ol>
<p>The system may use conditions not represented in the avaliable data such as employee rule, destination type, or approval, which can’t be incorporated.</p>
</section>
<section id="overall" class="level3" data-number="7.0.4">
<h3 data-number="7.0.4" class="anchored" data-anchor-id="overall"><span class="header-section-number">7.0.4</span> Overall</h3>
<p>These assumptions and constraints reflect the core challenge described in the PRD: <strong>reconstructing the behavior of a complex legacy system using only observable inputs and outputs.</strong> The feature engineering and modeling strategy attempt to balance accuracy, interpretability, and limitations of the dataset.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>